{% schema %}
{
  "name": "Custom Quiz",
  "settings": [
    {
      "type": "text",
      "id": "quiz_title",
      "label": "Quiz Title",
      "default": "Find Your Perfect Product"
    },
    {
      "type": "text",
      "id": "quiz_btn",
      "label": "Quiz Button",
      "default": "Start Quiz"
    },
    {
      "type": "color",
      "id": "btn_background_color",
      "label": "Button Background Color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "btn_text_color",
      "label": "Button Text Color",
      "default": "#ffffff"
    },
    {
      "type": "text",
      "id": "btn_padding",
      "label": "Button Padding",
      "default": "10px 20px"
    },
    {
      "type": "text",
      "id": "btn_border_radius",
      "label": "Button Border Radius",
      "default": "5px"
    },
    {
      "type": "text",
      "id": "font_family",
      "label": "Font Family",
      "default": "Arial, sans-serif"
    },
    {
      "type": "color",
      "id": "font_color",
      "label": "Font Color",
      "default": "#000000"
    },
    {
      "type": "text",
      "id": "font_size",
      "label": "Font Size",
      "default": "16px"
    },
    {
      "type": "color",
      "id": "radio_background_color",
      "label": "Radio Background Color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "radio_border_color",
      "label": "Radio Border Color",
      "default": "#000000"
    },
    {
      "type": "text",
      "id": "radio_size",
      "label": "Radio Size",
      "default": "20px"
    },
    {
      "type": "text",
      "id": "quiz_container_padding",
      "label": "Quiz Container Padding",
      "default": "20px"
    }
  ],
  "blocks": [
    {
      "type": "question",
      "name": "Question",
      "settings": [
        {
          "type": "text",
          "id": "question_text",
          "label": "Question Text"
        },
        {
          "type": "text",
          "id": "answer_1",
          "label": "Answer 1"
        },
        {
          "type": "product_list",
          "id": "recommended_products_1",
          "label": "Recommended Products for Answer 1"
        },
        {
          "type": "text",
          "id": "answer_2",
          "label": "Answer 2"
        },
        {
          "type": "product_list",
          "id": "recommended_products_2",
          "label": "Recommended Products for Answer 2"
        },
        {
          "type": "text",
          "id": "answer_3",
          "label": "Answer 3"
        },
        {
          "type": "product_list",
          "id": "recommended_products_3",
          "label": "Recommended Products for Answer 3"
        },
        {
          "type": "text",
          "id": "answer_4",
          "label": "Answer 4"
        },
        {
          "type": "product_list",
          "id": "recommended_products_4",
          "label": "Recommended Products for Answer 4"
        },
        {
          "type": "text",
          "id": "answer_5",
          "label": "Answer 5"
        },
        {
          "type": "product_list",
          "id": "recommended_products_5",
          "label": "Recommended Products for Answer 5"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Custom Quiz",
      "category": "Custom"
    }
  ]
}
{% endschema %}

<div class="quiz-container">
  <h2>{{ section.settings.quiz_title }}</h2>
  <button class="quiz-btn">{{ section.settings.quiz_btn }}</button>
  <div class="quiz-slider">
    {% for block in section.blocks %}
      {% if block.type == 'question' %}
        <div class="quiz-question" data-question-id="{{ forloop.index }}">
          <h3>{{ block.settings.question_text }}</h3>
          <div class="quiz-answers">
            {% assign answers = "troll,answer_1,answer_2,answer_3,answer_4,answer_5" | split: ',' %}
            {% for i in (0..5) %}
              {% assign answer_key = answers[i] %}
              {% assign answer = block.settings[answer_key] %}
              {% assign products_key = "recommended_products_" | append: i %}
              {% assign recommended_products_list = block.settings[products_key] | json %}
  
              {% if answer and i != 0 %}
                <script>
                  var answerIndex = "{{ forloop.index }}_{{ i }}";
                  var recommendedProducts = {{ recommended_products_list }};
                  console.log("Answer Group:", answerIndex, "Recommended Products:", recommendedProducts);
                </script>
                <div class="quiz-block">
                  <input 
                    class="questionInput" 
                    type="checkbox" 
                    name="question_{{ forloop.index }}" 
                    value="{{ forloop.index }}_{{ i }}" 
                    id="answer_{{ forloop.index }}_{{ i }}" 
                    data-products="{{ recommended_products_list | escape }}">
                  <label class="quiz-answer" for="answer_{{ forloop.index }}_{{ i }}">{{ answer }}</label>
                  <div class="recommended-products" style="display:none;">
                    {% if recommended_products_list.size > 0 %}
                      {% for product in recommended_products_list %}
                        <input type="hidden" class="recommended-product-ids" value="{{ product }}">
                      {% endfor %}
                    {% else %}
                      <p>No products available for this answer.</p>
                    {% endif %}
                  </div>
                </div>
              {% endif %}
            {% endfor %}
          </div>
        </div>
      {% endif %}
    {% endfor %}
  </div>
  <div class="quiz-navigation">
    <button id="prev-question" style="display:none;">Back</button>
    <button id="submit-quiz" style="display:none;">Submit Quiz</button>
  </div>
  <div id="quiz-results" style="display:none;">
    <h3>Recommended Products</h3>
    <div id="recommended-products-container"></div>
  </div>
</div>




<style>
  .quiz-slider {
    display: none;
    flex-wrap: nowrap;
    overflow: hidden;
  }

  .quiz-container {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    width: 100%;
    padding: 20px;
  }

  .quiz-btn {
    border: solid black;
    padding: .25rem;
    cursor: pointer;
  }

  .quiz-question {
    display: flex;
    flex-direction: column;
    min-width: 100%;
    transition: opacity 0.5s ease-in-out;
    justify-content: center;
    align-items: center;
}

  .quiz-question.active {
    display: block;
    opacity: 1;
  }

  .quiz-navigation {
    margin-top: 20px;
  }

  .quiz-answer {
    margin-bottom: 10px;
  }

  .recommended-products {
    display: flex;
    flex-wrap: wrap;
  }

  .product {
    margin-right: 10px;
    margin-bottom: 10px;
  }

  .product img {
    width: 50px;
    height: 50px;
  }

  .result-stack {
  display: flex;
  flex-direction: column;
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    let quizSlider = document.querySelector(".quiz-slider");
    let quizResults = [];
    let selectedProducts = [];
    let quizBtn = document.querySelector(".quiz-btn");

    document.querySelectorAll('.questionInput').forEach(input => {
      input.addEventListener('change', function() {
        const products = JSON.parse(this.dataset.products || '[]');
        if (this.checked) {
          quizResults.push(...products);
        } else {
          quizResults = quizResults.filter(p => !products.includes(p));
        }
        console.log('Selected Products:', quizResults);
      });
    });

    document.getElementById('submit-quiz').addEventListener('click', function() {
      const productFrequency = {};
      let mostFrequentProduct = null;
      let maxCount = 0;

      quizResults.forEach(product => {
        const productId = JSON.stringify(product);
        if (!productFrequency[productId]) {
          productFrequency[productId] = { count: 0, product };
        }
        productFrequency[productId].count++;

        if (productFrequency[productId].count > maxCount) {
          maxCount = productFrequency[productId].count;
          mostFrequentProduct = productFrequency[productId].product;
        }
      });

      console.log('Most Recommended Product:', mostFrequentProduct);
      displayRecommendedProduct(mostFrequentProduct);
    });

    function displayRecommendedProduct(product) {
      document.querySelector('#submit-quiz').style.display = 'none';
      quizSlider.style.display = 'none';
      const container = document.getElementById('recommended-products-container');
      container.innerHTML = ''; // Clear previous results
      const productElement = document.createElement('div');
      productElement.classList.add('result-stack');
      const resetBtn = document.createElement('button');
      resetBtn.textContent = 'Take the Quiz Again'; 
      resetBtn.classList.add('reset-button');
      productElement.textContent = 'Most Recommended Product: ' + product.title; // Replace with product details if available
      container.appendChild(productElement);
      productElement.appendChild(resetBtn);
      document.getElementById('quiz-results').style.display = 'block';
      resetBtn.addEventListener("click", resetQuiz);
      
    }

    function resetQuiz() {
      quizSlider.style.display = 'flex';
      const container = document.getElementById('recommended-products-container');
      container.style.display = 'none';
      document.querySelectorAll('.questionInput').forEach(input => {
        input.checked = false;
      });
      quizResults = [];
      selectedProducts = [];
      resetToFirstQuestion()
    }
    
    
    
    
    
    function startQuiz() {
      console.log("Tetsing");
      quizSlider.style.display = 'flex'
      quizBtn.style.display = 'none';

    }


    function nextQuestion() {
      // Get the width of each item (assuming they are all the same width)
      const quizQuestion = document.querySelector('.quiz-question').offsetWidth;
      
      // Calculate the next scroll position
      const currentQuestion = quizSlider.scrollLeft;
      const nextQuest = currentQuestion + quizQuestion;
  
      // Hide the submit button initially
      document.getElementById('submit-quiz').style.display = 'none';
  
      // Scroll to the next item
      quizSlider.scrollTo({
          left: nextQuest,
          behavior: 'smooth' // Adds smooth scrolling animation
      });
  
      // Check if it is the last item
      const totalItems = document.querySelectorAll('.quiz-question').length;
      const currentIndex = Math.round(nextQuest / quizQuestion);
  
      if (currentIndex >= totalItems - 1) {
          // Show the submit button if it is the last item
          document.getElementById('submit-quiz').style.display = 'block';
      }
  }

  function resetToFirstQuestion() {
    console.log('resetToFirstQuestion');
    quizSlider.scrollTo({
        left: 0,
        behavior: 'smooth' // Adds smooth scrolling animation
    });
}

      function addAnswerListeners() {
      let inputs = document.querySelectorAll('.questionInput');
      inputs.forEach(input => {
        let labelText = input.closest('.quiz-block').querySelector('label');
        if (labelText && !labelText.textContent.trim()) {
          input.closest('.quiz-block').style.display = 'none';
        } else {
          input.addEventListener('change', nextQuestion);
        }
      });
    }

    
    let questions = document.querySelectorAll('.quiz-question');
    let currentQuestionIndex = 0;

    if (quizBtn) {
      quizBtn.addEventListener("click", startQuiz);
      addAnswerListeners();
    } else {
      console.error("Quiz button not found");
    }
  });
</script>
